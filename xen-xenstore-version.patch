# HG changeset patch
# User kfraser@localhost.localdomain
# Node ID d71e72d8532cfdf5896f560d98d45262841c8b83
# Parent  7dfc65c380352627c1501fd34bdb1139bee3f3b4
Add versioning info to xenstore library.
From: Mark McLoughlin <markmc@redhat.com>
Signed-off-by: Keir Fraser <keir@xensource.com>

diff -burN xen-3.0.2.orig/tools/xenstore/Makefile xen-3.0.2/tools/xenstore/Makefile
--- xen-3.0.2.orig/tools/xenstore/Makefile	2006-07-26 15:50:33.550208000 +0200
+++ xen-3.0.2/tools/xenstore/Makefile	2006-07-26 15:54:26.068739500 +0200
@@ -2,6 +2,9 @@
 include $(XEN_ROOT)/tools/Rules.mk
 XEN_LIBXC          = $(XEN_ROOT)/tools/libxc
 
+MAJOR = 3.0
+MINOR = 0
+
 INSTALL         = install
 INSTALL_DATA	= $(INSTALL) -m0644
 INSTALL_PROG    = $(INSTALL) -m0755
@@ -77,11 +80,20 @@
 talloc_test.o: talloc.c
 	$(COMPILE.c) -o $@ $<
 
-libxenstore.so: xs.opic xs_lib.opic
-	$(CC) $(CFLAGS) $(LDFLAGS) -Wl,-soname -Wl,libxenstore.so -shared -o $@ $^ -lpthread
+libxenstore.so: libxenstore.so.$(MAJOR)
+	ln -sf $< $@
+
+libxenstore.so.$(MAJOR): libxenstore.so.$(MAJOR).$(MINOR)
+	ln -sf $< $@
+
+libxenstore.so.$(MAJOR).$(MINOR): xs.opic xs_lib.opic
+	$(CC) $(CFLAGS) $(LDFLAGS) -Wl,-soname -Wl,libxenstore.so.$(MAJOR) -shared -o $@ $^ -lpthread
+
+libxenstore.a: xs.o xs_lib.o
+	ar rcs libxenstore.a $^
 
 clean: testsuite-clean
-	rm -f *.o *.opic *.so
+	rm -f *.o *.opic *.so*
 	rm -f xenstored xs_random xs_stress xs_crashme
 	rm -f xs_test xenstored_test xs_tdb_dump xenstore-control xenstore-ls
 	rm -f $(CLIENTS)
@@ -147,7 +159,9 @@
 	$(INSTALL_PROG) xenstore-control $(DESTDIR)/usr/bin
 	$(INSTALL_PROG) xenstore-ls $(DESTDIR)/usr/bin
 	$(INSTALL_DIR) -p $(DESTDIR)/usr/$(LIBDIR)
-	$(INSTALL_DATA) libxenstore.so $(DESTDIR)/usr/$(LIBDIR)
+	$(INSTALL_DATA) libxenstore.so.$(MAJOR).$(MINOR) $(DESTDIR)/usr/$(LIBDIR)
+	ln -sf libxenstore.so.$(MAJOR).$(MINOR) $(DESTDIR)/usr/$(LIBDIR)/libxenstore.so.$(MAJOR)
+	ln -sf libxenstore.so.$(MAJOR) $(DESTDIR)/usr/$(LIBDIR)/libxenstore.so
 	$(INSTALL_DATA) xs.h $(DESTDIR)/usr/include
 	$(INSTALL_DATA) xs_lib.h $(DESTDIR)/usr/include
 
